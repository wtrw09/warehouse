# 系统配置路由说明

## 概述

`system_config_routes.py` 文件提供了系统配置管理的API接口，用于管理系统初始化状态和动态配置参数。所有接口都需要认证授权。

## API端点列表

### 1. 获取系统初始化状态

**端点**: `GET /system/init/status`

**作用**: 检查系统是否已完成初始化

**返回参数**:
- `initialized`: boolean - 系统是否已初始化
- `init_time`: datetime - 初始化时间（如果已初始化）
- `init_version`: string - 初始化版本号（如果已初始化）

**权限要求**: 需要认证用户

### 2. 初始化系统配置

**端点**: `POST /system/init`

**作用**: 执行系统初始化，创建默认配置参数

**返回参数**:
- `message`: string - 操作结果消息
- `init_time`: datetime - 初始化完成时间
- `status`: string - 操作状态（"success"）

**权限要求**: 需要认证用户

**注意事项**: 如果系统已初始化，将返回400错误

### 3. 获取所有系统配置

**端点**: `GET /system/config`

**作用**: 获取所有活跃的系统配置参数

**返回参数**:
- `configs`: array - 配置列表
  - `id`: int - 配置ID
  - `config_key`: string - 配置键
  - `config_value`: string - 配置值
  - `config_type`: string - 配置类型（string/int/bool）
  - `description`: string - 配置描述
  - `created_time`: datetime - 创建时间
  - `updated_time`: datetime - 更新时间
  - `is_active`: boolean - 是否启用
- `total`: int - 配置总数

**权限要求**: 需要认证用户

**前提条件**: 系统必须已初始化

### 4. 获取特定系统配置

**端点**: `GET /system/config/{config_key}`

**作用**: 根据配置键获取特定配置参数

**路径参数**:
- `config_key`: string - 配置键名

**返回参数**:
- `id`: int - 配置ID
- `config_key`: string - 配置键
- `config_value`: string - 配置值
- `config_type`: string - 配置类型
- `description`: string - 配置描述
- `created_time`: datetime - 创建时间
- `updated_time`: datetime - 更新时间
- `is_active`: boolean - 是否启用

**权限要求**: 需要认证用户

**前提条件**: 系统必须已初始化

### 5. 更新系统配置

**端点**: `PUT /system/config/{config_key}`

**作用**: 更新特定配置参数的值

**路径参数**:
- `config_key`: string - 配置键名

**请求参数**:
- `config_value`: string - 新的配置值

**返回参数**:
- `message`: string - 操作结果消息
- `config_key`: string - 配置键
- `config_value`: string - 更新后的配置值
- `updated_time`: datetime - 更新时间

**权限要求**: 需要认证用户

**前提条件**: 系统必须已初始化

**类型验证**:
- `int`类型：值必须是有效整数
- `bool`类型：值必须是"true"或"false"

## 可配置的系统参数

系统初始化时会创建以下默认配置参数：

### 1. 数据库配置
- **DATABASE_URL**: string - 数据库连接URL
  - 默认值: `"sqlite:///./warehouse.db"`
  - 作用: 指定数据库连接地址

### 2. JWT认证配置
- **SECRET_KEY**: string - JWT密钥
  - 默认值: `"your-secret-key"`
  - 作用: JWT令牌签名密钥
  - 描述: "JWT密钥"

- **ALGORITHM**: string - JWT算法
  - 默认值: `"HS256"`
  - 作用: JWT签名算法
  - 描述: "JWT算法"

- **ACCESS_TOKEN_EXPIRE_MINUTES**: int - JWT访问令牌过期时间
  - 默认值: `300`
  - 作用: JWT令牌有效时间（分钟）
  - 描述: "JWT访问令牌过期时间(分钟)"

### 3. 认证策略配置
- **AUTH_STRATEGY**: string - 认证策略
  - 默认值: `"jwt_fixed"`
  - 可选值: `"jwt_fixed"`, `"sliding_session"`
  - 作用: 选择认证策略
  - 描述: "认证策略 (jwt_fixed/sliding_session)"

- **SLIDING_SESSION_TIMEOUT_MINUTES**: int - 滑动会话超时时间
  - 默认值: `60`
  - 作用: 滑动会话模式下会话超时时间（分钟）
  - 描述: "滑动会话超时时间(分钟)"

- **ACCESS_TOKEN_SHORT_EXPIRE_MINUTES**: int - 短期访问令牌过期时间
  - 默认值: `15`
  - 作用: 短期令牌有效时间（分钟）
  - 描述: "短期访问令牌过期时间(分钟)"

### 4. 管理员配置
- **ADMIN_INVITATION_CODE**: string - 管理员邀请码
  - 默认值: `"admin-invite-code"`
  - 作用: 管理员注册邀请码
  - 描述: "管理员邀请码"

### 5. Redis配置
- **REDIS_URL**: string - Redis连接URL
  - 默认值: `"redis://:redis123@redis:6379"`
  - 作用: Redis服务器连接地址
  - 描述: "Redis连接URL"

## 配置类型说明

- **string**: 字符串类型，无特殊验证
- **int**: 整数类型，更新时会验证是否为有效整数
- **bool**: 布尔类型，更新时值必须是"true"或"false"

## 使用示例

### 1. 检查系统状态
```bash
curl -X GET "http://localhost:8000/system/init/status" \
  -H "Authorization: Bearer <token>"
```

### 2. 初始化系统
```bash
curl -X POST "http://localhost:8000/system/init" \
  -H "Authorization: Bearer <token>"
```

### 3. 获取所有配置
```bash
curl -X GET "http://localhost:8000/system/config" \
  -H "Authorization: Bearer <token>"
```

### 4. 更新配置
```bash
curl -X PUT "http://localhost:8000/system/config/AUTH_STRATEGY" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"config_value": "sliding_session"}'
```

## 注意事项

1. **系统初始化**: 必须先执行系统初始化才能使用配置管理功能
2. **权限控制**: 所有接口都需要有效的JWT令牌
3. **配置缓存**: 配置值有60秒缓存，更新后可能需要等待缓存过期
4. **类型安全**: 更新配置时会验证值类型，确保数据一致性
5. **生产环境**: 生产环境中应修改默认的SECRET_KEY和ADMIN_INVITATION_CODE

## 错误处理

- `400`: 请求参数错误或系统已初始化
- `404`: 配置不存在
- `500`: 服务器内部错误

所有错误都会返回详细的错误信息，便于调试。